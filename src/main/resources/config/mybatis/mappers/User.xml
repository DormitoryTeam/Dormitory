<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.noeasy.money.model.User">
	
	<insert id="register" parameterType="com.noeasy.money.model.UserBean">
		INSERT INTO USERS(login,
		password, email, create_date, update_date)
		VALUES(#{login}, md5(#{password}), #{login}, now(), now());
	</insert>


	<insert id="saveUser" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.UserBean">
		INSERT INTO users (login, password, email, name, gender, passport, age, birthday, address, phone, qq, create_date, update_date)
		VALUES(#{login}, md5(#{password}), #{login}, #{name}, #{gender}, #{passport}, ${age}, #{birthday}, #{address}, #{phone}, #{qq}, now(), now());
	</insert>


	<update id="updateUser" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			name = #{name},
			gender = #{gender},
			passport = #{passport},
			birthday = #{birthday},
			age = #{age},
			address = #{address},
			phone = #{phone},
			qq = #{qq},
			update_date = now()
		WHERE id = #{id}
	</update>


	<update id="resetPassword" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			password = md5(#{password}),
			update_date = now()
		WHERE login = #{login}
	</update>

	<update id="updateResetPasswordSign" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			reset_password_sign = #{resetPasswordSign},
			update_date = now()
		WHERE login = #{login}
	</update>

	<sql id="select-user-count">
		SELECT COUNT(*)
	</sql>
	<sql id="select-user-content">
		SELECT u.id, u.login, u.password, u.email, u.name, u.gender, u.passport, u.age, u.birthday, u.address, u.phone, u.qq
	</sql>
	<sql id="select-user-table-join">
		FROM users AS u LEFT JOIN user_group AS ugroup ON u.id = ugroup.user_id
	</sql>
	<sql id="select-user-query-condition">
		WHERE 1=1
		<if test="id != null">
			AND u.id = #{id}
		</if>
		<if test="login != null">
			AND (u.login = #{login}  OR u.email = #{login}) 
		</if>
		<if test="password != null">
			AND u.password = md5(#{password})
		</if>
		<if test="groupId != null">
			AND ugroup.group_id = #{groupId}
		</if>
		<if test="sign != null">
			AND u.reset_password_sign = #{sign}
		</if>
		<if test="searchKey != null">
			AND (u.id = #{searchKey} OR u.login like CONCAT('%', #{searchKey}, '%'))
		</if> 
	</sql>
	<sql id="limit-split-page">
		<if test="page != null">limit #{page.pageStartIndex}, #{page.pageSize}</if>
	</sql>
	<select id="queryUser" parameterType="com.noeasy.money.model.UserSearchBean"
		resultType="com.noeasy.money.model.UserBean">
		<include refid="select-user-content" />
		<include refid="select-user-table-join" />
		<include refid="select-user-query-condition" />
		<include refid="limit-split-page" />
	</select>
	<select id="queryUserCount" parameterType="com.noeasy.money.model.UserSearchBean"
		resultType="int">
		<include refid="select-user-count" />
		<include refid="select-user-table-join" />
		<include refid="select-user-query-condition" />
		<include refid="limit-split-page" />
	</select>
	
	<update id="updateUserInfo" parameterType="com.noeasy.money.model.UserInfoBean">
		UPDATE user_info SET
			<if test="name != null">
			name = #{name},
			</if>
			<if test="nationality != null">
			nationality = #{nationality},
			</if>
			<if test="email != null">
			email = #{email},
			</if>
			<if test="qq != null">
			qq = #{qq}
			</if>
			<if test="wechat != null">
			wechat = #{wechat},
			</if>
			<if test="phone != null">
			phone = #{phone},
			</if>
			<if test="country != null">
			country = #{country},
			</if>
			<if test="province != null">
			province = #{province},
			</if>
			<if test="city != null">
			city = #{city},
			</if>
			<if test="address != null">
			address = #{address},
			</if>
			<if test="birthday != null">
			birthday = #{birthday},
			</if>
			<if test="gender != null">
			gender = #{gender},
			</if>
			update_date = now()
		WHERE id = #{id}
	</update>
	<insert id="createUserInfo" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.UserInfoBean">
		INSERT INTO user_info (name, nationality, gender, birthday, email, qq, age, wechat, phone, country, province, city, address, create_date, update_date)
		VALUES(#{name}, #{nationality}, #{gender}, #{birthday}, #{email}, #{qq}, ${age}, #{wechat}, #{phone}, #{country}, #{province}, #{city}, #{address}, now(), now());
	</insert>
	<update id="setInfo2User" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			user_info_id = #{info.id},
			update_date = now()
		WHERE id = #{id}
	</update>
	<update id="setGuaranteeInfo2User" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			guarantee_info_id = #{guaranteeInfo.id},
			update_date = now()
		WHERE id = #{id}
	</update>
	<update id="setContactPersonInfo2User" parameterType="com.noeasy.money.model.UserBean">
		UPDATE users SET
			contact_person_info_id = #{contactPersonInfo.id},
			update_date = now()
		WHERE id = #{id}
	</update>
</mapper>