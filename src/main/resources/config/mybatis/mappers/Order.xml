<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.noeasy.money.model.Order">

	<sql id="select-dormitory-order">
		select t1.id, t1.user_id, t1.belongs_to, t1.type as order_type, t1.status as order_status, t1.currency, t1.amount, t1.create_time,
		t2.id as uid, t2.login as user_login, t2.password as user_password, t2.email as user_email, t2.name as user_name, t2.gender as user_gender, t2.passport as
		user_passport, t2.age as user_age, t2.birthday as user_birthday, t2.address as user_address, t2.qq as user_qq, t2.phone as user_phone,
		t3.id as bid, t3.login as belong_login, t3.password as belong_password, t3.email as belong_email, t3.name as belong_name, t3.gender as belong_gender, t3.passport as
		belong_passport, t3.age as belong_age, t3.birthday as belong_birthday, t3.address as belong_address, t3.qq as belong_qq, t3.phone as belong_phone,
		t4.id as cid, t4.name as contact_name, t4.gender as
		contact_gender, t4.qq as contact_qq, t4.phone as contact_phone, t4.address as contact_address,
		t5.id as lid, t5.dormitory_id, t5.amount as li_amount, t5.currency as li_currency, t5.listPrice as li_listPrice,
		t6.id as did, t6.city_id, t6.type_id, t6.contract_type_id, t6.name as dname, t6.address as daddress, t6.postcode, t6.listPrice as dlistPrice, t6.salePrice, t6.currency as dcurrency,
		t6.equipment, t6.service, t6.description, t6.status as dstatus
		from `order` t1
		left join users t2 on t1.user_id = t2.id
		left join users t3 on t1.belongs_to = t3.id
		left join order_contact_info t4 on t1.id = t4.order_id
		left join line_item_dormitory t5 on t1.id = t5.order_id
		left join dormitory t6 on
		t5.dormitory_id = t6.id
	</sql>

	<sql id="select-pickup-order">
		select t1.id, t1.user_id, t1.belongs_to, t1.type as order_type, t1.status as order_status, t1.currency, t1.amount, t1.create_time,
		t2.id as uid, t2.login as user_login, t2.password as user_password, t2.email as user_email, t2.name as user_name, t2.gender as user_gender, t2.passport as
		user_passport, t2.age as user_age, t2.birthday as user_birthday, t2.address as user_address, t2.qq as user_qq, t2.phone as user_phone,
		t3.id as bid, t3.login as belong_login, t3.password as belong_password, t3.email as belong_email, t3.name as belong_name, t3.gender as belong_gender, t3.passport as
		belong_passport, t3.age as belong_age, t3.birthday as belong_birthday, t3.address as belong_address, t3.qq as belong_qq, t3.phone as belong_phone,
		t4.id as cid, t4.name as contact_name, t4.gender as
		contact_gender, t4.qq as contact_qq, t4.phone as contact_phone, t4.address as contact_address,
		t5.id as lid, t5.flight_number, t5.city_id, t5.pickup_date, t5.pickup_type, t5.luggage_amount, t5.luggage_size, t5.amount as li_amount, t5.currency as li_currency,
		t6.name as city_name
		from `order` t1
		left join users t2 on t1.user_id = t2.id
		left join users t3 on t1.belongs_to = t3.id
		left join order_contact_info t4 on t1.id = t4.order_id
		left join line_item_pickup t5 on t1.id = t5.order_id
		left join city t6 on t5.city_id = t6.id
	</sql>

	<sql id="where">
		where 1=1
	</sql>

	<sql id="limit-split-page">
		limit #{pageBean.pageStartIndex}, #{pageBean.pageSize}
	</sql>

	<select id="queryDormitoryOrder" resultMap="dormitory-order">
		<include refid="select-dormitory-order" />
		<include refid="where" />
		<if test="orderNumber != null">
			and t1.id = #{orderNumber}
		</if>
		<if test="dateFrom != null">
			and t1.create_time &gt;= #{dateFrom}
		</if>
		<if test="dateTo != null">
			and t1.create_time &lt;= #{dateTo}
		</if>
		<if test="user != null">
			and t1.belongs_to = #{user.id}
		</if>
		<if test="orderType != null">
			and t1.type = #{orderType}
		</if>
		<if test="pageBean != null">
			<include refid="limit-split-page" />
		</if>
	</select>

	<select id="queryPickupOrder" resultMap="pickup-order">
		<include refid="select-pickup-order" />
		<include refid="where" />
		<if test="orderNumber != null">
			and t1.id = #{orderNumber}
		</if>
		<if test="dateFrom != null">
			and t1.create_time &gt;= #{dateFrom}
		</if>
		<if test="dateTo != null">
			and t1.create_time &lt;= #{dateTo}
		</if>
		<if test="user != null">
			and t1.belongs_to = #{user.id}
		</if>
		<if test="orderType != null">
			and t1.type = #{orderType}
		</if>
		<if test="pageBean != null">
			<include refid="limit-split-page" />
		</if>
	</select>

	<insert id="saveOrder" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.OrderBean">
		insert into `order` (user_id, belongs_to, `type`, status, amount, currency) values (
		#{user.id,javaType=int,jdbcType=INTEGER},
		#{belongsTo.id,javaType=int,jdbcType=INTEGER},
		#{orderType.name,javaType=String,jdbcType=VARCHAR},
		#{orderStatus.name,javaType=String,jdbcType=VARCHAR},
		#{amount,javaType=java.math.BigDecimal,jdbcType=DECIMAL},
		#{currency,javaType=String,jdbcType=VARCHAR}
		)
	</insert>

	<insert id="saveOrderContactInfo" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.OrderContactInfo">
		insert into order_contact_info (order_id, name, gender, qq, phone, address) values (
		#{orderId,javaType=int,jdbcType=INTEGER},
		#{name,javaType=String,jdbcType=INTEGER},
		#{gender,javaType=boolean,jdbcType=INTEGER},
		#{QQ,javaType=String,jdbcType=VARCHAR},
		#{phone,javaType=String,jdbcType=VARCHAR},
		#{address,javaType=String,jdbcType=VARCHAR}
		)
	</insert>

	<insert id="saveOrderHistory" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.OrderTail">
		insert into order_history (order_id, operator_id, operation) values (
		#{orderId,javaType=int,jdbcType=INTEGER},
		#{operator.id,javaType=int,jdbcType=INTEGER},
		#{operation.name,javaType=String,jdbcType=VARCHAR}
		)
	</insert>

	<insert id="saveDormitoryLineItem" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.DormitoryLineItem">
		insert into line_item_dormitory (order_id, dormitory_id, listPrice, amount, currency) values (
		#{orderId,javaType=int,jdbcType=INTEGER},
		#{dormitory.id,javaType=int,jdbcType=INTEGER},
		#{listPrice,javaType=java.math.BigDecimal,jdbcType=DECIMAL},
		#{amount,javaType=java.math.BigDecimal,jdbcType=DECIMAL},
		#{currency,javaType=String,jdbcType=VARCHAR}
		)
	</insert>

	<insert id="savePickupLineItem" keyProperty="id" useGeneratedKeys="true" parameterType="com.noeasy.money.model.PickupLineItem">
		insert into line_item_pickup (order_id, flight_number, city_id, pickup_date, pickup_type, amount, currency, luggage_amount, luggage_size) values (
		#{orderId,javaType=int,jdbcType=INTEGER},
		#{flightNum,javaType=String,jdbcType=VARCHAR},
		#{cityId,javaType=int,jdbcType=INTEGER},
		#{pickupDate,javaType=java.util.Date,jdbcType=TIMESTAMP},
		#{pickupType.value,javaType=int,jdbcType=VARCHAR},
		#{amount,javaType=java.math.BigDecimal,jdbcType=DECIMAL},
		#{currency,javaType=String,jdbcType=VARCHAR},
		#{luggageAmount,javaType=int,jdbcType=INTEGER},
		#{luggageSize,javaType=Double,jdbcType=DECIMAL}
		)
	</insert>
	
	<select id="isPaymentDone" parameterType="int" resultType="int">
		SELECT count(id) FROM `order` WHERE id = #{id} AND (status = 'COMMIT' OR status = 'REVIEW' OR status = 'PAYMENT');
	</select>
	
	<update id="updateOrderStatus" parameterType="com.noeasy.money.model.OrderBean">
		UPDATE `order` SET
			status = #{orderStatus.name,javaType=String,jdbcType=VARCHAR},
			update_time = now()
		WHERE id = #{id}
	</update>

	<resultMap id="dormitory-order" type="com.noeasy.money.model.OrderBean">
		<id column="id" property="id" />
		<result property="orderType" column="order_type" />
		<result property="orderStatus" column="order_status" />
		<result property="currency" column="currency" />
		<result property="amount" column="amount" />
		<result property="createTime" column="create_time" />
		<association property="user" column="user_id" javaType="com.noeasy.money.model.UserBean">
			<id property="id" column="uid" />
			<result property="login" column="user_login" />
			<result property="password" column="user_password" />
			<result property="email" column="user_email" />
			<result property="name" column="user_name" />
			<result property="gender" column="user_gender" />
			<result property="passport" column="user_passport" />
			<result property="birthday" column="user_birthday" />
			<result property="address" column="user_address" />
			<result property="qq" column="user_qq" />
			<result property="phone" column="user_phone" />
		</association>
		<association property="belongsTo" column="belongs_to" javaType="com.noeasy.money.model.UserBean">
			<id property="id" column="bid" />
			<result property="login" column="belong_login" />
			<result property="password" column="belong_password" />
			<result property="email" column="belong_email" />
			<result property="name" column="belong_name" />
			<result property="gender" column="belong_gender" />
			<result property="passport" column="belong_passport" />
			<result property="birthday" column="belong_birthday" />
			<result property="address" column="belong_address" />
			<result property="qq" column="belong_qq" />
			<result property="phone" column="belong_phone" />
		</association>
		<association property="orderContact" column="cid" javaType="com.noeasy.money.model.OrderContactInfo">
			<id property="id" column="cid" />
			<result property="name" column="contact_name" />
			<result property="gender" column="contact_gender" />
			<result property="QQ" column="contact_qq" />
			<result property="phone" column="contact_phone" />
			<result property="address" column="contact_address" />
		</association>
		<collection property="lineItems" ofType="com.noeasy.money.model.DormitoryLineItem">
			<id property="id" column="lid" />
			<result property="amount" column="li_amount" />
			<result property="listPrice" column="li_listPrice" />
			<result property="currency" column="li_currency" />
			<association property="dormitory" column="dormitory_id" javaType="com.noeasy.money.model.DormitoryBean">
				<id property="id" column="did" />
				<result property="cityId" column="city_id" />
				<result property="dormitoryTypeId" column="type_id" />
				<result property="contractId" column="contract_type_id" />
				<result property="name" column="dname" />
				<result property="address" column="daddress" />
				<result property="postCode" column="postcode" />
				<result property="listPrice" column="dlistPrice" />
				<result property="salePrice" column="salePrice" />
				<result property="currency" column="dcurrency" />
				<result property="equipment" column="equipment" />
				<result property="service" column="service" />
				<result property="description" column="description" />
				<result property="status" column="dstatus" />
			</association>
		</collection>
	</resultMap>

	<resultMap id="pickup-order" type="com.noeasy.money.model.OrderBean">
		<id column="id" property="id" />
		<result property="orderType" column="order_type" />
		<result property="orderStatus" column="order_status" />
		<result property="currency" column="currency" />
		<result property="amount" column="amount" />
		<result property="createTime" column="create_time" />
		<association property="user" column="user_id" javaType="com.noeasy.money.model.UserBean">
			<id property="id" column="uid" />
			<result property="login" column="user_login" />
			<result property="password" column="user_password" />
			<result property="email" column="user_email" />
			<result property="name" column="user_name" />
			<result property="gender" column="user_gender" />
			<result property="passport" column="user_passport" />
			<result property="birthday" column="user_birthday" />
			<result property="address" column="user_address" />
			<result property="qq" column="user_qq" />
			<result property="phone" column="user_phone" />
		</association>
		<association property="belongsTo" column="belongs_to" javaType="com.noeasy.money.model.UserBean">
			<id property="id" column="bid" />
			<result property="login" column="belong_login" />
			<result property="password" column="belong_password" />
			<result property="email" column="belong_email" />
			<result property="name" column="belong_name" />
			<result property="gender" column="belong_gender" />
			<result property="passport" column="belong_passport" />
			<result property="birthday" column="belong_birthday" />
			<result property="address" column="belong_address" />
			<result property="qq" column="belong_qq" />
			<result property="phone" column="belong_phone" />
		</association>
		<association property="orderContact" column="cid" javaType="com.noeasy.money.model.OrderContactInfo">
			<id property="id" column="cid" />
			<result property="name" column="contact_name" />
			<result property="gender" column="contact_gender" />
			<result property="QQ" column="contact_qq" />
			<result property="phone" column="contact_phone" />
			<result property="address" column="contact_address" />
		</association>
		<collection property="lineItems" ofType="com.noeasy.money.model.PickupLineItem">
			<id property="id" column="lid" />
			<result property="flightNum" column="flight_number" />
			<result property="cityId" column="city_id" />
			<result property="landingCity" column="city_name" />
			<result property="pickupDate" column="pickup_date" />
			<result property="pickupType" column="pickup_type" />
			<result property="luggageAmount" column="luggage_amount" />
			<result property="luggageSize" column="luggage_size" />
			<result property="amount" column="li_amount" />
			<result property="currency" column="li_currency" />
		</collection>
	</resultMap>
</mapper>